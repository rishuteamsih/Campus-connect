<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Campus Connect – Unite Your Campus</title>
  <link rel="icon" href="CAMPUS CONNECT.png" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      background: #f2f4f8;
      padding: 20px;
    }

    /* make header positioned so absolute profile button can sit inside it */
    header {
      background: #18ab91;
      color: #fff;
      text-align: center;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      position: relative;
    }

    header img {
      height: 70px;
      display: block;
      margin: 0 auto 8px;
    }

    header h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }

    header p {
      font-size: 15px;
      opacity: 0.95;
    }

    .view {
      display: none;
    }

    .profile-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: #fff;
      color: #18ab91;
      font-size: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 10px auto;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }

    /* Faculty-style top-right profile button */
    .profile-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #fff;
      color: #18ab91;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      border: none;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      transition: transform 0.2s ease;
    }

    .profile-btn:hover {
      transform: scale(1.1);
    }

    .container {
      position: relative;
      width: min(900px, 95%);
      height: 550px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      margin: auto;
    }

    .form-container {
      position: absolute;
      top: 0;
      height: 100%;
      transition: all 0.6s ease-in-out;
    }

    .sign-in-container {
      left: 0;
      width: 50%;
      z-index: 2;
    }

    .sign-up-container {
      left: 0;
      width: 50%;
      opacity: 0;
      z-index: 1;
    }

    form {
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0 50px;
      text-align: center;
    }

    form h1 {
      color: #18ab91;
      margin-bottom: 14px;
      font-weight: 700;
    }

    input,
    select {
      width: 100%;
      max-width: 320px;
      padding: 12px 14px;
      margin: 8px 0;
      border-radius: 8px;
      border: none;
      background: #f0f1f3;
    }

    button {
      margin-top: 14px;
      padding: 12px 42px;
      border-radius: 999px;
      border: none;
      background: #18ab91;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s ease;
    }

    button:active {
      transform: scale(.98);
    }

    button.ghost {
      background: transparent;
      border: 2px solid rgba(255, 255, 255, 0.35);
      color: #fff;
      padding: 10px 30px;
    }

    .overlay-container {
      position: absolute;
      top: 0;
      left: 50%;
      width: 50%;
      height: 100%;
      overflow: hidden;
      transition: transform 0.6s ease-in-out;
      z-index: 100;
    }

    .overlay {
      position: relative;
      left: -100%;
      width: 200%;
      height: 100%;
      display: flex;
      align-items: center;
      transition: transform 0.6s ease-in-out;
      background: linear-gradient(90deg, #20b39a 0%, #17a88a 100%);
      color: #fff;
    }

    .overlay-panel {
      width: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 40px;
      text-align: center;
    }

    .container.right-panel-active .sign-in-container {
      transform: translateX(100%);
      opacity: 0;
    }

    .container.right-panel-active .sign-up-container {
      transform: translateX(100%);
      opacity: 1;
      z-index: 5;
    }

    .container.right-panel-active .overlay-container {
      transform: translateX(-100%);
    }

    .container.right-panel-active .overlay {
      transform: translateX(50%);
    }

    .chat-buttons {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-width: 250px;
      margin-top: 10px;
    }

    .chat-btn {
      display: block;
      padding: 12px;
      text-align: center;
      border: 2px solid #18ab91;
      border-radius: 10px;
      color: #18ab91;
      text-decoration: none;
      font-weight: 600;
      background: #fff;
      transition: 0.3s;
    }

    .chat-btn:hover {
      background: #18ab91;
      color: #fff;
    }

    .logout-btn {
      margin-top: 30px;
      padding: 12px 25px;
      border-radius: 10px;
      border: none;
      background: #18ab91;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .logout-btn:hover {
      background: #13967d;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal-box {
      background: #fff;
      padding: 20px;
      border-radius: 14px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .modal-box h3 {
      color: #18ab91;
      margin-bottom: 10px;
    }

    .modal-box input,
    .modal-box textarea,
    .modal-box select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 6px 0;
    }

    .modal-box button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #18ab91;
      color: #fff;
    }

    .notice-card {
      background: #fff;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      margin-top: 10px;
    }

    /* Profile Modal */
    .profile-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    .profile-box {
      background: #fff;
      padding: 25px;
      border-radius: 14px;
      width: 90%;
      max-width: 380px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .profile-box h2 {
      color: #18ab91;
      margin-bottom: 10px;
    }

    .profile-box input,
    .profile-box textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin: 6px 0;
    }

    .profile-box button {
      margin-top: 10px;
      padding: 10px 20px;
      border: none;
      background: #18ab91;
      color: #fff;
      border-radius: 8px;
    }
  </style>
</head>

<body>

  <!-- LOGIN / SIGNUP -->
  <div id="loginView" class="view" style="display:block;">
    <header>
      <img src="CAMPUS CONNECT.png">
      <h1>Campus Connect</h1>
      <p>Unite Your Campus</p>
    </header>
    <div class="container" id="container">
      <div class="form-container sign-up-container">
        <form id="signupForm">
          <h1>Create Account</h1>
          <input id="signupName" type="text" placeholder="Name" required />
          <input id="signupEmail" type="email" placeholder="Email" required />
          <input id="signupPassword" type="password" placeholder="Password" required />
          <select id="signupRole" required>
            <option value="" disabled selected>Select role</option>
            <option value="student">Student</option>
            <option value="faculty">Faculty</option>
            <option value="hod">HOD / Admin</option>
          </select>
          <button type="submit">Sign Up</button>
        </form>
      </div>
      <div class="form-container sign-in-container">
        <form id="loginForm">
          <h1>Sign In</h1>
          <input id="loginEmail" type="email" placeholder="Email" required />
          <input id="loginPassword" type="password" placeholder="Password" required />
          <button type="submit">Login</button>
        </form>
      </div>
      <div class="overlay-container">
        <div class="overlay">
          <div class="overlay-panel overlay-left">
            <h1>Welcome Back!</h1>
            <p>Login with your account</p><button class="ghost" id="signIn">Sign In</button>
          </div>
          <div class="overlay-panel overlay-right">
            <h1>Hello!</h1>
            <p>Enter your details and start your journey</p>
            <button class="ghost" id="signUp">Sign Up</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN / HOD DASHBOARD -->
  <div id="facultyView" class="view">
    <header>
      <img src="CAMPUS CONNECT.png">
      <h1>Campus Connect</h1>
      <p>Admin / HOD Dashboard</p>
      <!-- Profile button (top-right) for admin -->
      <button id="profileBtn" class="profile-btn" title="Profile">👤</button>
    </header>

    <main>
      <h3 style="margin-top:25px;">Pending Signups:</h3>
      <table id="pendingTable">
        <thead>
          <tr>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <section style="margin-top:20px;">
        <h3>Chat Options</h3>
        <div class="chat-buttons">
          <a href="chat.html" target="_blank" class="chat-btn">🌐 Global Chat</a>
          <a href="private.html" target="_blank" class="chat-btn">💬 Private Chat</a>
          <a href="groups.html" target="_blank" class="chat-btn">👥 Groups</a>
        </div>
      </section>

      <section style="margin-top:25px;">
        <button id="openNoticeModal" class="chat-btn">📁 Send Notice</button>
        <h3 style="margin-top:15px;">📜 Sent Notices</h3>
        <div id="sentNotices" style="margin-top:10px;"></div>
      </section>

      <button id="logoutBtnFaculty" class="logout-btn">Logout</button>
    </main>
  </div>

  <!-- STUDENT DASHBOARD -->
  <!-- STUDENT DASHBOARD -->
  <div id="studentView" class="view">
    <header>
      <img src="CAMPUS CONNECT.png">
      <h1>Campus Connect</h1>
      <p>Student Dashboard</p>
      <!-- Profile button (top-right) for student -->
      <button id="profileBtn2" class="profile-btn" title="Profile">👤</button>
    </header>

    <main>
      <section>
        <h3 style="margin-top:25px;">Chat Options</h3>
        <div class="chat-buttons">
          <a href="chat.html" target="_blank" class="chat-btn">🌐 Global Chat</a>
          <a href="private.html" target="_blank" class="chat-btn">💬 Private Chat</a>
          <a href="groups.html" target="_blank" class="chat-btn">👥 Groups</a>
          <!-- NEW Classroom button -->
          <a href="classroom.html" target="_blank" class="chat-btn">🏫 Classroom</a>
        </div>
      </section>

      <section style="margin-top:30px;">
        <h3>📢 Notices</h3>
        <div id="studentNotices" style="margin-top:10px;display:flex;flex-direction:column;gap:10px;"></div>
      </section>
      <button id="logoutBtnStudent" class="logout-btn">Logout</button>
    </main>
  </div>

  <!-- Notice Modal -->
  <div id="noticeModal" class="modal">
    <div class="modal-box">
      <h3>Send Notice</h3>
      <input type="text" id="noticeTitle" placeholder="Notice title" required />
      <textarea id="noticeMsg" rows="3" placeholder="Notice message"></textarea>
      <select id="noticeTarget">
        <option value="both">Students & Faculty</option>
        <option value="students">Students Only</option>
        <option value="faculty">Faculty Only</option>
      </select>
      <input type="file" id="noticeFile" accept=".pdf,image/*" />
      <button id="sendNoticeBtn">Send Notice</button>
      <button onclick="document.getElementById('noticeModal').style.display='none'">Cancel</button>
    </div>
  </div>

  <!-- Profile Modal (shared) -->
  <div id="profileModal" class="profile-modal">
    <div class="profile-box">
      <h2>Your Profile</h2>
      <label>Name</label><input type="text" id="profName" />
      <label>Email</label><input type="email" id="profEmail" disabled />
      <label>Role</label><input type="text" id="profRole" disabled />
      <label>Bio</label><textarea id="profBio" rows="3"></textarea>
      <label>Profile Image</label><input type="file" id="profImage" accept="image/*" />
      <div style="display:flex;gap:8px;">
        <button id="saveProfile">Save</button>
        <button id="closeProfile" style="background:#ccc;color:#000;margin-left:8px;">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      auth, db, storage,
      signOut, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp,
      createUserWithEmailAndPassword, signInWithEmailAndPassword,
      sRef, uploadBytesResumable, getDownloadURL
    } from "./firebase.js";
    import { onAuthStateChanged } from "./firebase.js";
    /* --- EXISTING WORKING LOGIC (unchanged) --- */
    function showView(id) {
      document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
      document.getElementById(id).style.display = 'block';
    }

    document.getElementById('signupForm').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const name = signupName.value.trim();
        const email = signupEmail.value.trim();
        const pass = signupPassword.value;
        const role = signupRole.value;
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, 'users', cred.user.uid), {
          name, email, role, approved: false, uid: cred.user.uid, createdAt: serverTimestamp()
        });
        alert('✅ Account created! Awaiting admin approval.');
        await signOut(auth);
      } catch (err) { console.error(err); alert("Signup failed: " + (err.message || err.code)); }
    });
    const _c = document.getElementById('container');
    signUp.onclick = () => _c.classList.add('right-panel-active');
    signIn.onclick = () => _c.classList.remove('right-panel-active');
    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      try {
        const email = loginEmail.value.trim();
        const pass = loginPassword.value;
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (err) { console.error(err); alert("Login failed: " + (err.message || err.code)); }
    });

    onAuthStateChanged(auth, async user => {
      try {
        if (!user) return showView('loginView');
        const snap = await getDoc(doc(db, 'users', user.uid));
        if (!snap.exists()) return showView('loginView');
        const p = snap.data();
        if (!p.approved) { alert("Waiting for approval by admin"); await signOut(auth); return; }
        if (p.role === 'hod' || p.role === 'admin') {
  // Show HOD/Admin dashboard inside this file
  showView('facultyView');
  loadPending();
  loadSentNotices();
} 
else if (p.role === 'faculty') {
  // Redirect faculty to their dedicated dashboard page
  window.location.href = "faculty_dashboard.html";
} 
else {
  // Student dashboard
  showView('studentView');
}
      } catch (e) { console.error(e); showView('loginView'); }
    });

    function loadPending() {
      const body = document.querySelector("#pendingTable tbody");
      const q = query(collection(db, "users"), where("approved", "==", false));
      onSnapshot(q, snap => {
        body.innerHTML = "";
        snap.forEach(d => {
          const u = d.data();
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${u.email}</td><td>${u.role}</td><td>${u.approved ? "Approved" : "Pending"}</td>
        <td><button data-id="${u.uid}">Approve</button></td>`;
          body.appendChild(tr);
        });
        body.querySelectorAll("button").forEach(btn => {
          btn.onclick = async e => {
            await updateDoc(doc(db, "users", e.target.dataset.id), { approved: true });
            alert("✅ User approved");
          };
        });
      });
    }

    const noticeModal = document.getElementById("noticeModal");
    document.getElementById("openNoticeModal")?.addEventListener("click", () => noticeModal.style.display = "flex");
    document.getElementById("sendNoticeBtn")?.addEventListener("click", async () => {
      try {
        const title = noticeTitle.value.trim();
        const message = noticeMsg.value.trim();
        const target = noticeTarget.value;
        const file = noticeFile.files[0];
        if (!title || !message) return alert("Fill all fields");
        let fileURL = "", fileName = "";
        if (file) {
          if (!file.type.includes("pdf") && !file.type.includes("image"))
            return alert("Only PDF or Images allowed");
          const ref = sRef(storage, "notices/" + Date.now() + "_" + file.name);
          await uploadBytesResumable(ref, file);
          fileURL = await getDownloadURL(ref);
          fileName = file.name;
        }
        await addDoc(collection(db, "notices"), { title, message, target, fileURL, fileName, sender: auth.currentUser.email, createdAt: serverTimestamp() });
        alert("✅ Notice sent successfully!"); noticeModal.style.display = "none";
      } catch (err) { console.error(err); alert("Notice failed: " + err.message); }
    });

    function loadSentNotices() {
      const list = document.getElementById("sentNotices");
      if (!list) return;
      const q = query(collection(db, "notices"), where("sender", "==", auth.currentUser.email), orderBy("createdAt", "desc"));
      onSnapshot(q, snap => {
        list.innerHTML = "";
        snap.forEach(d => {
          const n = d.data();
          const div = document.createElement("div");
          div.className = "notice-card";
          div.innerHTML = `<strong>${n.title}</strong><br>${n.message}<br>${n.fileURL ? `<a href="${n.fileURL}" target="_blank">📎 ${n.fileName}</a><br>` : ""}
      <small>${n.createdAt?.toDate?.()?.toLocaleString?.() || ""} | ${n.target}</small>`;
          list.appendChild(div);
        });
      });
    }

    const studentNotices = document.getElementById("studentNotices");
    if (studentNotices) {
      const q = query(collection(db, "notices"), orderBy("createdAt", "desc"));
      onSnapshot(q, snap => {
        studentNotices.innerHTML = "";
        snap.forEach(d => {
          const n = d.data();
          if (n.target === "students" || n.target === "both") {
            const div = document.createElement("div");
            div.className = "notice-card";
            div.innerHTML = `<strong>${n.title}</strong><p>${n.message}</p>${n.fileURL ? `<a href="${n.fileURL}" target="_blank" style="color:#18ab91;">📎 ${n.fileName}</a>` : ""}
        <div style="font-size:12px;color:#777;">${n.createdAt?.toDate?.()?.toLocaleString?.() || ""}</div>`;
            studentNotices.appendChild(div);
          }
        });
      });
    }

    document.getElementById("logoutBtnFaculty")?.addEventListener("click", async () => { await signOut(auth); location.reload(); });
    document.getElementById("logoutBtnStudent")?.addEventListener("click", async () => { await signOut(auth); location.reload(); });

    /* --- PROFILE MODAL (Firebase-connected) --- */
    const profileModal = document.getElementById("profileModal");
    const profileBtns = [document.getElementById("profileBtn"), document.getElementById("profileBtn2")];
    const closeProfile = document.getElementById("closeProfile");
    const profName = document.getElementById("profName");
    const profEmail = document.getElementById("profEmail");
    const profRole = document.getElementById("profRole");
    const profBio = document.getElementById("profBio");
    const profImage = document.getElementById("profImage");
    const saveProfileBtn = document.getElementById("saveProfile");

    profileBtns.forEach(btn => {
      if (!btn) return;
      btn.addEventListener("click", async () => {
        try {
          if (!auth.currentUser) return alert("Not logged in");
          const snap = await getDoc(doc(db, "users", auth.currentUser.uid));
          const p = snap.exists() ? snap.data() : {};
          profName.value = p.name || "";
          profEmail.value = p.email || auth.currentUser.email || "";
          profRole.value = p.role || "";
          profBio.value = p.bio || "";
          // clear file input
          profImage.value = "";
          profileModal.style.display = "flex";
        } catch (err) {
          console.error("Profile load error:", err);
          alert("Failed to load profile");
        }
      });
    });

    closeProfile?.addEventListener("click", () => profileModal.style.display = "none");

    saveProfileBtn?.addEventListener("click", async () => {
      try {
        if (!auth.currentUser) return alert("Not logged in");
        const uid = auth.currentUser.uid;
        const name = profName.value.trim();
        const bio = profBio.value.trim();
        let photoURL = null;
        const file = profImage.files[0];
        if (file) {
          const ref = sRef(storage, "profiles/" + uid + "_" + file.name);
          const uploadTask = await uploadBytesResumable(ref, file);
          photoURL = await getDownloadURL(uploadTask.ref);
        }
        const updatePayload = { name, bio, updatedAt: new Date() };
        if (photoURL) updatePayload.photoURL = photoURL;
        await updateDoc(doc(db, "users", uid), updatePayload);
        alert("✅ Profile updated!");
        profileModal.style.display = "none";
      } catch (err) {
        console.error("Profile save error:", err);
        alert("Failed to save profile: " + (err.message || err));
      }
    });
  </script>
</body>

</html>